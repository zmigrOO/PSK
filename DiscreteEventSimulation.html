<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discrete Event Simulation</title>
</head>

<body>
    <form action="" method="get">
        <fieldset>
            <legend>Discrete Event Simulation</legend>
            <label for="sims">Number of simulations:</label>
            <input type="number" value="1000" name="sims" id="sims">
            <button type="submit">Simulate</button>
            <div id="results" style="float: right;"></div>
        </fieldset>
    </form>
    <script src="chart.js"></script>
    <canvas id="capitalChart" width="800" height="400"></canvas>

    <script>
        function poisson(lambda) {
            const L = Math.exp(-lambda);
            let p = 1.0;
            let k = 0;

            do {
                k++;
                p *= Math.random();
            } while (p > L);

            return k - 1;
        }

        function simulateSingle() {
            const lambda_claim = 10; // Poisson rate for claims per day
            const mean_claim = 1000; // Mean claim amount
            const daily_payment = 11000; // Daily payment received
            const initial_capital = 25000; // Initial capital
            let capital = initial_capital;
            const days = 365;
            let capitalData = [];

            for (let i = 0; i < days; i++) {
                // Generate number of claims for the day
                const num_claims = poisson(lambda_claim);

                // Calculate total claim amount for the day
                const total_claim_amount = num_claims * mean_claim;

                // Subtract claim amount from capital
                capital -= total_claim_amount;

                // Add daily payment to capital
                capital += daily_payment;

                // Check if capital becomes negative
                if (capital <= 0) {
                    capitalData.push(capital);
                    return capitalData;
                }
                capitalData.push(capital);
            }

            return capitalData;
        }

        function simulateMultiple(n) {
            let simulationSuccessRate = [];
            let bestSimulation = 0;
            let worstSimulation = [];
            for (let i = 0; i < n; i++) {
                const capitalData = simulateSingle();
                if (i == 0) {
                    bestSimulation = capitalData;
                    worstSimulation = capitalData;
                } else {
                    if (worstSimulation[worstSimulation.length - 1] > capitalData[capitalData.length - 1] || worstSimulation.length > capitalData.length) {
                        worstSimulation = capitalData;
                    }
                    if (bestSimulation[bestSimulation.length - 1] < capitalData[capitalData.length - 1] || bestSimulation.length < capitalData.length) {
                        bestSimulation = capitalData;
                    }
                    if (capitalData[capitalData.length - 1] > 0) {
                        simulationSuccessRate++;
                    }
                }
            }



            return { bestSimulation, worstSimulation, simulationSuccessRate };
        }

        if (new URLSearchParams(window.location.search).get('sims')) {
            const sims = document.querySelector('#sims').value = parseInt(new URLSearchParams(window.location.search).get('sims'));
            const { bestSimulation, worstSimulation, simulationSuccessRate} = simulateMultiple(sims);
            document.querySelector('#results').innerHTML = `Success Rate: ${simulationSuccessRate / sims * 100}%`;
            // Display capital data on the chart
            const ctx = document.getElementById('capitalChart').getContext('2d');
            const chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Array.from({ length: 365 }, (_, i) => i + 1),
                    datasets: [{
                        label: 'Best Simulation',
                        data: bestSimulation,
                        fill: false,
                        borderColor: 'green',
                        borderWidth: 1,
                        pointRadius: 0
                    }, {
                        label: 'Worst Simulation',
                        data: worstSimulation,
                        fill: false,
                        borderColor: 'red',
                        borderWidth: 1,
                        pointRadius: 0
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            min: 0, // Add this line to set the minimum value of the y-axis to 0
                            title: {
                                display: true,
                                text: 'Capital ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Days'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>

</html>